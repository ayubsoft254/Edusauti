{% extends 'base.html' %}

{% block title %}Dashboard - EduSauti{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Your Dashboard</h1>
    
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Upload a Document</h2>
        <form id="upload-form" class="space-y-4">
            <div>
                <label for="document-title" class="block text-gray-700 mb-1">Document Title</label>
                <input type="text" id="document-title" name="title" class="w-full px-4 py-2 border rounded-md" required>
            </div>
            <div>
                <label for="document-file" class="block text-gray-700 mb-1">Document File (PDF, DOCX)</label>
                <input type="file" id="document-file" name="file" class="w-full px-4 py-2 border rounded-md" accept=".pdf,.docx" required>
            </div>
            <div>
                <label for="voice-type" class="block text-gray-700 mb-1">Voice Type</label>
                <select id="voice-type" name="voice_type" class="w-full px-4 py-2 border rounded-md">
                    <option value="en-US-JennyNeural">Jenny (Female)</option>
                    <option value="en-US-GuyNeural">Guy (Male)</option>
                    <option value="en-US-AriaNeural">Aria (Female)</option>
                    <option value="en-US-DavisNeural">Davis (Male)</option>
                </select>
            </div>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">Upload Document</button>
        </form>
        <div id="upload-status" class="mt-4 hidden">
            <div class="flex items-center">
                <svg class="animate-spin h-5 w-5 mr-3 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Processing your document...</span>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Your Documents</h2>
        <div id="documents-list" class="space-y-4">
            <!-- Documents will be loaded here -->
            <div class="text-gray-500">Loading your documents...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load user's documents
    loadDocuments();
    
    // Handle document upload
    const uploadForm = document.getElementById('upload-form');
    const uploadStatus = document.getElementById('upload-status');
    
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(uploadForm);
        uploadStatus.classList.remove('hidden');
        
        fetch('/api/upload/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            uploadStatus.classList.add('hidden');
            uploadForm.reset();
            loadDocuments(); // Refresh document list
            
            // Redirect to player page
            window.location.href = `/player/${data.document_id}/`;
        })
        .catch(error => {
            console.error('Error:', error);
            uploadStatus.innerHTML = '<div class="text-red-600">Error uploading document. Please try again.</div>';
        });
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Function to load user's documents
    function loadDocuments() {
        const documentsList = document.getElementById('documents-list');
        
        fetch('/api/documents/')
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                documentsList.innerHTML = '<div class="text-gray-500">You have no documents yet. Upload one to get started!</div>';
                return;
            }
            
            documentsList.innerHTML = '';
            data.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'border rounded-md p-4 flex justify-between items-center';
                docElement.innerHTML = `
                    <div>
                        <h3 class="font-medium">${doc.title}</h3>
                        <p class="text-sm text-gray-500">Uploaded on ${new Date(doc.upload_date).toLocaleDateString()}</p>
                    </div>
                    <a href="/player/${doc.id}/" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-md">Listen</a>
                `;
                documentsList.appendChild(docElement);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            documentsList.innerHTML = '<div class="text-red-600">Error loading documents. Please refresh the page.</div>';
        });
    }
});
</script>
{% endblock %}